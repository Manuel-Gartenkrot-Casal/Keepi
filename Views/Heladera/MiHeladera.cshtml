@using System.Collections.Generic
@using Keepi.Models
@using System.Linq

@{
    var Productos = ViewBag.Productos as List<ProductoXHeladera> ?? new List<ProductoXHeladera>();
    var BD = new BD();
    var todosProductos = BD.GetAllProductos();
    var Color = ViewBag.Color ?? "#7ecb20";
}

<div class="mi-heladera-container">
    <div class="heladera-controls">
        <input type="search" id="busquedaProductos" class="buscador-heladera" placeholder="Buscar productos...">
        <button type="button" class="btn-cambiar-heladera" onclick="window.location.href='@Url.Action("Heladeras", "Heladera")'">
            Cambiar Heladera
        </button>
    </div>

    <!-- Dise√±o de heladera abierta con perspectiva interior -->
    <div class="heladera-exterior" style="--heladera-color: @Color;">
        <!-- Perspectiva de puertas abiertas -->
        <div class="heladera-puerta-izquierda-abierta"></div>
        <div class="heladera-puerta-derecha-abierta"></div>
        
        <!-- Interior visible de la heladera -->
        <div class="heladera-interior">
            <!-- Estantes horizontales -->
            <div class="estante estante-1"></div>
            <div class="estante estante-2"></div>
            <div class="estante estante-3"></div>
            
            <div class="productos-scroll-container">
                @if (Productos != null && Productos.Count > 0)
                {
                    @foreach (ProductoXHeladera producto in Productos)
                    {
                        var productoBase = todosProductos.FirstOrDefault(p => p.ID == producto.IdProducto);
                        int duracionTotal = productoBase?.Duracion ?? 30;
                        int diasRestantes = producto.ObtenerDiasRestantes();
                        int diasDesdeCarga = producto.ObtenerDiasDesdeCarga(duracionTotal);
                        double porcentaje = producto.CalcularPorcentajeVencimiento(duracionTotal);
                        var fechaCarga = producto.FechaVencimiento.AddDays(-duracionTotal);
                        if (fechaCarga > DateTime.Now) fechaCarga = DateTime.Now;
                        
                        <div class="producto-card" data-producto-id="@producto.ID" data-producto-base-id="@producto.IdProducto">
                            <button class="btn-eliminar" onclick="eliminarProducto(@producto.ID, @producto.IdProducto)" title="Eliminar producto">
                                ‚úï
                            </button>
                            
                            <div class="producto-imagen">
                                <img src="@Url.Content($"~/imagenes/Productos/{producto.Foto}")" alt="@producto.NombreEspecifico" />
                            </div>
                            
                            <div class="producto-info">
                                <div class="contenedor-nombre-dias">
                                    <div class="contenedor-nombre-fecha">
                                        <h3 class="producto-nombre">@producto.NombreEspecifico</h3>
                                    </div>
                                    <div class="producto-dias">
                                        @if (diasRestantes < 0)
                                        {
                                            <span class="dias-vencido">Vencido hace @Math.Abs(diasRestantes) d√≠as</span>
                                        }
                                        else if (diasRestantes == 0)
                                        {
                                            <span class="dias-venciendo">Vence hoy</span>
                                        }
                                        else
                                        {
                                            <span class="dias-restantes">@diasRestantes d√≠a@(diasRestantes != 1 ? "s" : "") restante@(diasRestantes != 1 ? "s" : "")</span>
                                        }
                                    </div>
                                </div>
                                <div class="producto-fecha">
                                    <span class="label">Cargado:</span>
                                    <span class="valor">@fechaCarga.ToString("dd/MM/yyyy")</span>
                                </div>
                                <div class="contenedor-progress-acciones">
                                    <div class="producto-progress">
                                        <div class="progress-bar-container">
                                            <div class="progress-bar" style="width: @porcentaje%; background: @(porcentaje > 50 ? "linear-gradient(90deg, #6cc04a, #b4df33)" : porcentaje > 25 ? "linear-gradient(90deg, #f5a623, #f5d123)" : "linear-gradient(90deg, #e74c3c, #c0392b)")"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="producto-acciones">
                                        <!-- Bot√≥n dropdown para Abierto/Cerrado -->
                                        <div class="dropdown-estado">
                                            <button class="btn-estado @(producto.Abierto ? "abierto" : "cerrado")" onclick="toggleDropdownEstado(event, @producto.ID)">
                                                @(producto.Abierto ? "üîì Abierto" : "üîí Cerrado")
                                            </button>
                                            <div class="dropdown-menu-estado" id="dropdown-@producto.ID">
                                                <button onclick="cambiarEstadoAbierto(@producto.ID, false)" class="dropdown-item">üîí Cerrado</button>
                                                <button onclick="cambiarEstadoAbierto(@producto.ID, true)" class="dropdown-item">üîì Abierto</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Nuevo bot√≥n dropdown para Tipo de Almacenamiento -->
                                        <div class="dropdown-tipo">
                                            <button class="btn-tipo tipo-@(producto.TipoAlmacenamiento?.ToLower() ?? "refrigerado")" onclick="toggleDropdownTipo(event, @producto.ID)">
                                                @{
                                                    var icono = producto.TipoAlmacenamiento == "Congelado" ? "‚ùÑÔ∏è" : producto.TipoAlmacenamiento == "Alacena" ? "üì¶" : "üßä";
                                                    var texto = producto.TipoAlmacenamiento ?? "Refrigerado";
                                                }
                                                @icono @texto
                                            </button>
                                            <div class="dropdown-menu-tipo" id="dropdown-tipo-@producto.ID">
                                                <button onclick="cambiarTipoAlmacenamiento(@producto.ID, 'Refrigerado')" class="dropdown-item">üßä Refrigerado</button>
                                                <button onclick="cambiarTipoAlmacenamiento(@producto.ID, 'Congelado')" class="dropdown-item">‚ùÑÔ∏è Congelado</button>
                                                <button onclick="cambiarTipoAlmacenamiento(@producto.ID, 'Alacena')" class="dropdown-item">üì¶ Alacena</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="sin-productos">
                        <p>No hay productos en la heladera</p>
                        <a href="@Url.Action("AgregarProducto", "Home")" class="btn-agregar-primero">Agregar primer producto</a>
                    </div>
                }
            </div>
        </div>
    </div>

    <a href="@Url.Action("AgregarProducto", "Home")" class="btn-agregar-producto" title="Agregar producto">
        +
    </a>
</div>

<script>
function toggleDropdownEstado(event, productoId) {
    event.stopPropagation();
    const dropdown = document.getElementById(`dropdown-${productoId}`);
    const allDropdowns = document.querySelectorAll('.dropdown-menu-estado, .dropdown-menu-tipo');
    
    allDropdowns.forEach(d => {
        if (d.id !== `dropdown-${productoId}`) {
            d.classList.remove('show');
        }
    });
    
    dropdown.classList.toggle('show');
}

function toggleDropdownTipo(event, productoId) {
    event.stopPropagation();
    const dropdown = document.getElementById(`dropdown-tipo-${productoId}`);
    const allDropdowns = document.querySelectorAll('.dropdown-menu-estado, .dropdown-menu-tipo');
    
    allDropdowns.forEach(d => {
        if (d.id !== `dropdown-tipo-${productoId}`) {
            d.classList.remove('show');
        }
    });
    
    dropdown.classList.toggle('show');
}

document.addEventListener('click', function() {
    const allDropdowns = document.querySelectorAll('.dropdown-menu-estado, .dropdown-menu-tipo');
    allDropdowns.forEach(d => d.classList.remove('show'));
});

function eliminarProducto(idProductoXHeladera, idProducto) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('idProductoXHeladera', idProductoXHeladera);
    formData.append('idProducto', idProducto);
    
    fetch('@Url.Action("EliminarProducto", "Heladera")', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-producto-id="${idProductoXHeladera}"]`).remove();
            
            const productosRestantes = document.querySelectorAll('.producto-card').length;
            if (productosRestantes === 0) {
                location.reload();
            }
        } else {
            alert('Error al eliminar el producto: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar el producto');
    });
}

function cambiarEstadoAbierto(idProductoXHeladera, abierto) {
    const formData = new FormData();
    formData.append('idProductoXHeladera', idProductoXHeladera);
    formData.append('abierto', abierto);
    
    fetch('@Url.Action("CambiarEstadoAbierto", "Heladera")', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al cambiar el estado: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al cambiar el estado');
    });
}

function cambiarTipoAlmacenamiento(idProductoXHeladera, tipoAlmacenamiento) {
    const formData = new FormData();
    formData.append('idProductoXHeladera', idProductoXHeladera);
    formData.append('tipoAlmacenamiento', tipoAlmacenamiento);
    
    fetch('@Url.Action("CambiarTipoAlmacenamiento", "Heladera")', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al cambiar el tipo de almacenamiento: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al cambiar el tipo de almacenamiento');
    });
}

document.getElementById('busquedaProductos').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const productos = document.querySelectorAll('.producto-card');
    
    productos.forEach(producto => {
        const nombre = producto.querySelector('.producto-nombre').textContent.toLowerCase();
        if (nombre.includes(searchTerm)) {
            producto.style.display = 'flex';
        } else {
            producto.style.display = 'none';
        }
    });
});
</script>

<style>
.mi-heladera-container {
    width: 100%;
    min-height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
    position: relative;
}

.heladera-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    width: 90%;
    max-width: 800px;
    z-index: 10;
}

.buscador-heladera {
    flex: 1;
    padding: 12px 20px;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(6px);
    border: 2px solid #ddd;
    border-radius: 25px;
    font-size: 16px;
    transition: all 0.3s;
}

.buscador-heladera:focus {
    outline: none;
    border-color: #59ad44;
    background-color: white;
}

.btn-cambiar-heladera {
    padding: 12px 24px;
    background-color: rgba(33, 33, 33, 0.8);
    backdrop-filter: blur(6px);
    border: none;
    border-radius: 25px;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-cambiar-heladera:hover {
    background-color: rgba(33, 33, 33, 0.95);
    transform: translateY(-2px);
}

/* Redise√±o completo: heladera abierta con perspectiva */
.heladera-exterior {
    position: relative;
    width: 90%;
    max-width: 800px;
    background: linear-gradient(180deg, 
        rgba(245, 245, 250, 0.98) 0%,
        rgba(250, 250, 255, 0.95) 100%);
    border-radius: 20px;
    padding: 40px 30px 30px 30px;
    box-shadow: 
        0 25px 60px rgba(0, 0, 0, 0.25),
        inset 0 8px 20px rgba(255, 255, 255, 0.6);
    border: 3px solid color-mix(in srgb, var(--heladera-color) 60%, #888);
    overflow: visible;
}

/* Puertas abiertas en perspectiva */
.heladera-puerta-izquierda-abierta {
    position: absolute;
    top: -10px;
    left: -80px;
    width: 90px;
    height: calc(100% + 20px);
    background: linear-gradient(135deg, 
        color-mix(in srgb, var(--heladera-color) 75%, black) 0%,
        var(--heladera-color) 30%,
        color-mix(in srgb, var(--heladera-color) 90%, white) 60%,
        color-mix(in srgb, var(--heladera-color) 80%, black) 100%);
    border-radius: 15px 5px 5px 15px;
    transform: perspective(600px) rotateY(-35deg);
    box-shadow: 
        -5px 8px 20px rgba(0, 0, 0, 0.3),
        inset 2px 4px 8px rgba(255, 255, 255, 0.3),
        inset -2px -2px 6px rgba(0, 0, 0, 0.2);
    z-index: 1;
}

.heladera-puerta-derecha-abierta {
    position: absolute;
    top: -10px;
    right: -80px;
    width: 90px;
    height: calc(100% + 20px);
    background: linear-gradient(225deg, 
        color-mix(in srgb, var(--heladera-color) 75%, black) 0%,
        var(--heladera-color) 30%,
        color-mix(in srgb, var(--heladera-color) 90%, white) 60%,
        color-mix(in srgb, var(--heladera-color) 80%, black) 100%);
    border-radius: 5px 15px 15px 5px;
    transform: perspective(600px) rotateY(35deg);
    box-shadow: 
        5px 8px 20px rgba(0, 0, 0, 0.3),
        inset -2px 4px 8px rgba(255, 255, 255, 0.3),
        inset 2px -2px 6px rgba(0, 0, 0, 0.2);
    z-index: 1;
}

/* Manijas en las puertas */
.heladera-puerta-izquierda-abierta::before {
    content: '';
    position: absolute;
    top: 50%;
    right: 15px;
    transform: translateY(-50%);
    width: 6px;
    height: 100px;
    background: linear-gradient(180deg, #b8b8b8, #f5f5f5 50%, #b8b8b8);
    border-radius: 3px;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
}

.heladera-puerta-derecha-abierta::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 15px;
    transform: translateY(-50%);
    width: 6px;
    height: 100px;
    background: linear-gradient(180deg, #b8b8b8, #f5f5f5 50%, #b8b8b8);
    border-radius: 3px;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
}

/* Interior de la heladera */
.heladera-interior {
    position: relative;
    width: 100%;
    min-height: 400px;
    background: linear-gradient(180deg, 
        rgba(255, 255, 255, 0.95) 0%,
        rgba(248, 250, 252, 0.98) 50%,
        rgba(240, 245, 250, 0.95) 100%);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 
        inset 0 6px 15px rgba(0, 0, 0, 0.08),
        inset 0 -4px 10px rgba(0, 0, 0, 0.05);
}

/* Estantes horizontales dentro de la heladera */
.estante {
    position: absolute;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, 
        transparent 0%,
        rgba(200, 200, 200, 0.4) 5%,
        rgba(180, 180, 180, 0.5) 50%,
        rgba(200, 200, 200, 0.4) 95%,
        transparent 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    z-index: 0;
}

.estante-1 {
    top: 25%;
}

.estante-2 {
    top: 50%;
}

.estante-3 {
    top: 75%;
}

.productos-scroll-container {
    position: relative;
    width: 100%;
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px;
    border-radius: 12px;
    z-index: 2;
}

.productos-scroll-container::-webkit-scrollbar {
    width: 8px;
}

.productos-scroll-container::-webkit-scrollbar-track {
    background: rgba(241, 241, 241, 0.5);
    border-radius: 10px;
}

.productos-scroll-container::-webkit-scrollbar-thumb {
    background: rgba(89, 173, 68, 0.7);
    border-radius: 10px;
}

.productos-scroll-container::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 141, 56, 0.9);
}

.producto-card {
    position: relative;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.95) 0%,
        rgba(250, 250, 250, 0.98) 50%,
        rgba(245, 245, 245, 0.95) 100%);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    gap: 20px;
    align-items: flex-start;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.producto-card:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 6px 16px rgba(0, 0, 0, 0.12),
        0 2px 4px rgba(0, 0, 0, 0.08);
}

.btn-eliminar {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    border: none;
    background: #f0efe6;
    color: gray;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-eliminar:hover {
    color: black;
    transform: scale(1.1);
}

.producto-imagen {
    flex-shrink: 0;
    width: 100px;
    height: 100px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.producto-imagen img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.producto-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.producto-nombre {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.producto-fecha {
    font-size: 14px;
    color: #666;
}

.producto-fecha .label {
    font-weight: 500;
}

.producto-dias {
    font-size: 16px;
    font-weight: 600;
}

.dias-restantes {
    color: #6cc04a;
}

.dias-venciendo {
    color: #f5a623;
}

.dias-vencido {
    color: #e74c3c;
}

.contenedor-progress-acciones {
    display: flex;
    align-items: center;
    gap: 20px;
}

.producto-progress {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.progress-bar-container {
    width: 100%;
    height: 10px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease, background 0.3s ease;
}

.producto-acciones {
    width: 50%;
    display: flex;
    gap: 10px;
}

/* Estilos para ambos dropdowns */
.dropdown-estado,
.dropdown-tipo {
    position: relative;
    flex: 1;
}

.btn-estado,
.btn-tipo {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #59ad44;
    background: white;
    color: #59ad44;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.btn-estado:hover,
.btn-tipo:hover {
    background: #59ad44;
    color: white;
}

.btn-estado.abierto {
    border-color: #f5a623;
    color: #f5a623;
}

.btn-estado.abierto:hover {
    background: #f5a623;
    color: white;
}

.btn-tipo.tipo-congelado {
    border-color: #3498db;
    color: #3498db;
}

.btn-tipo.tipo-congelado:hover {
    background: #3498db;
    color: white;
}

.btn-tipo.tipo-alacena {
    border-color: #9b59b6;
    color: #9b59b6;
}

.btn-tipo.tipo-alacena:hover {
    background: #9b59b6;
    color: white;
}

.dropdown-menu-estado,
.dropdown-menu-tipo {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    margin-top: 5px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none;
    z-index: 100;
    overflow: hidden;
}

.dropdown-menu-estado.show,
.dropdown-menu-tipo.show {
    display: block;
}

.dropdown-item {
    width: 100%;
    padding: 10px 16px;
    border: none;
    background: white;
    color: #333;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.dropdown-item:hover {
    background: #f5f5f5;
    color: #59ad44;
}

.dropdown-item:not(:last-child) {
    border-bottom: 1px solid #eee;
}

.sin-productos {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.sin-productos p {
    font-size: 18px;
    margin-bottom: 20px;
}

.btn-agregar-primero {
    display: inline-block;
    padding: 12px 24px;
    background-color: white;
    color: #59ad44;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-agregar-primero:hover {
    background-color: #59ad44;
    color: white;
    transform: translateY(-2px);
}

.btn-agregar-producto {
    position: fixed;
    bottom: 40px;
    right: 40px;
    width: 60px;
    height: 60px;
    background-color: #59ad44;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(89, 173, 68, 0.4);
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    line-height: 1;
}

.btn-agregar-producto:hover {
    background-color: #4a8d38;
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(89, 173, 68, 0.6);
}

@@media (max-width: 768px) {
    .heladera-exterior {
        width: 95%;
        padding: 30px 20px 20px 20px;
    }
    
    .heladera-puerta-izquierda-abierta,
    .heladera-puerta-derecha-abierta {
        width: 60px;
    }
    
    .heladera-puerta-izquierda-abierta {
        left: -65px;
    }
    
    .heladera-puerta-derecha-abierta {
        right: -65px;
    }
    
    .productos-scroll-container {
        padding: 15px;
    }
    
    .producto-card {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .producto-imagen {
        width: 120px;
        height: 120px;
    }
    
    .producto-acciones {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-estado,
    .btn-tipo,
    .dropdown-estado,
    .dropdown-tipo {
        width: 100%;
    }
}
</style>
